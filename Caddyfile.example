# Caddyfile Configuration for chess.cflux.org
# Place this in /etc/caddy/Caddyfile or your Caddy config directory

chess.cflux.org {
    # Automatic HTTPS via Let's Encrypt (Caddy handles this automatically)
    
    # Backend API endpoints
    handle /api/* {
        reverse_proxy localhost:3004 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # WebSocket endpoint for Socket.IO
    handle /socket.io/* {
        reverse_proxy localhost:3004 {
            # WebSocket support
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            
            # Enable WebSocket upgrades
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }
    
    # Health check endpoint
    handle /health {
        reverse_proxy localhost:3004
    }
    
    # Frontend - everything else
    handle {
        reverse_proxy localhost:3005 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            
            # WebSocket support for Vite HMR (Hot Module Replacement)
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }
    
    # Logging (optional)
    log {
        output file /var/log/caddy/chess.cflux.org.log
        format json
    }
}
